<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Arrosage</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  #output { font-size: 1.2em; }
</style>
</head>
<body>
<h2>Arrosage</h2>
<div id="output">Loading...</div>
  <br/>
<strong>Schedule</strong><br/>
<i>Mon: 2pm-5pm <br/>
Tue: 8am-11am <br/>
Wed: 2am-5am <br/>
Thu: 8pm-11pm <br/>
Fri: 2pm-5pm <br/>
Sat: 8am-11am <br/>
Sun: 2am-5am </i>
  
<script>
// Sample JSON schedule: daily array of on/off intervals (24h format "HH:mm")
const schedule = {
  "Monday": [
    { "on": "14:00", "off": "17:00" }
  ],
  "Tuesday": [
    { "on": "08:00", "off": "11:00" }
  ],
  "Wednesday": [
    { "on": "02:00", "off": "05:00" }
  ],
  "Thursday": [
    { "on": "20:00", "off": "23:00" }
  ],
  "Friday": [
    { "on": "14:00", "off": "17:00" }
  ],
  "Saturday": [
    { "on": "08:00", "off": "11:00" }
  ],
  "Sunday": [
    { "on": "02:00", "off": "05:00" }
  ]
};

// Utility to convert "HH:mm" string to minutes from midnight
function timeToMinutes(t) {
  const [h, m] = t.split(":").map(Number);
  return h * 60 + m;
}

// Gets current day name string (e.g. "Monday")
function getCurrentDayName() {
  return new Date().toLocaleDateString('en-US', { weekday: 'long' });
}

// Returns the minutes from midnight now
function getMinutesNow() {
  const now = new Date();
  return now.getHours() * 60 + now.getMinutes();
}

// Format minutes from midnight as HH:mm string
function formatMinutes(m) {
  const hh = String(Math.floor(m / 60)).padStart(2, '0');
  const mm = String(m % 60).padStart(2, '0');
  return `${hh}:${mm}`;
}

// Helper to get day name by index offset
const daysOfWeek = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];

function getDayNameByOffset(offset) {
  const todayIndex = daysOfWeek.indexOf(getCurrentDayName());
  return daysOfWeek[(todayIndex + offset + 7) % 7];
}

// Main logic to check current state and generate message with day info
function getCurrentState(schedule) {
  const today = getCurrentDayName();
  const intervalsToday = schedule[today] || [];
  const now = getMinutesNow();
  let isOn = false;
  let currentOnInterval = null;

  // Check if current time falls in any on interval
  for (const interval of intervalsToday) {
    const onMin = timeToMinutes(interval.on);
    const offMin = timeToMinutes(interval.off);
    if (now >= onMin && now < offMin) {
      isOn = true;
      currentOnInterval = interval;
      break;
    }
  }

  // Helper to find last on interval (and day)
  function findLastOn() {
    let lastInterval = null;
    let lastDayOffset = 0; // 0 means today
    for (let offset = 0; offset < 7; offset++) {
      const dayName = getDayNameByOffset(-offset);
      const dayIntervals = schedule[dayName] || [];
      for (const interval of dayIntervals) {
        const offMin = timeToMinutes(interval.off);
        if (offset === 0) {
          // Today
          if (offMin <= now) {
            return { interval, day: dayName };
          }
        } else {
          // Previous days, take latest interval
          if (!lastInterval || offMin > timeToMinutes(lastInterval.off)) {
            lastInterval = interval;
            lastDayOffset = offset;
          }
        }
      }
      if (lastInterval) break;
    }
    if (lastInterval) {
      const day = getDayNameByOffset(-lastDayOffset);
      return { interval: lastInterval, day };
    }
    return null;
  }

  // Helper to find next on interval (and day)
  function findNextOn() {
    let nextInterval = null;
    let nextDayOffset = 0; // 0 means today
    for (let offset = 0; offset < 7; offset++) {
      const dayName = getDayNameByOffset(offset);
      const dayIntervals = schedule[dayName] || [];
      for (const interval of dayIntervals) {
        const onMin = timeToMinutes(interval.on);
        if (offset === 0) {
          if (onMin > now) {
            return { interval, day: dayName };
          }
        } else {
          if (!nextInterval || onMin < timeToMinutes(nextInterval.on)) {
            nextInterval = interval;
            nextDayOffset = offset;
          }
        }
      }
      if (nextInterval) break;
    }
    if (nextInterval) {
      const day = getDayNameByOffset(nextDayOffset);
      return { interval: nextInterval, day };
    }
    return null;
  }

  if (isOn) {
    // Currently ON
    return `<span style="color: green;">The water is ON since ${currentOnInterval.on} on ${today} and will go OFF at ${currentOnInterval.off}.</span>`;
  } else {
    // Currently OFF
    const lastOn = findLastOn();
    const nextOn = findNextOn();

    const lastOnStr = lastOn ? `was last ON on ${lastOn.day} until ${lastOn.interval.off}` : "has not been ON yet";
    const nextOnStr = nextOn ? `will be ON again on ${nextOn.day} at ${nextOn.interval.on}` : "will not be ON again soon";

    return `<span style="color: red;">The water is OFF, it ${lastOnStr} and ${nextOnStr}.</span>`;
  }
}

// Display function
function updateDisplay() {
  const output = document.getElementById("output");
  output.innerHTML = getCurrentState(schedule);
}

// Initial call and refresh every minute
updateDisplay();
setInterval(updateDisplay, 60000);

</script>
</body>
</html>
